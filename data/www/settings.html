<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MQTT Settings Â· SwitchNode</title>
  <meta charset="UTF-8">
  <style>
    /* Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #1d1d1f;
    }
    
    /* Card Container */
    .wrap {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.08),
        0 1px 2px rgba(0, 0, 0, 0.05),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: fadeIn 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      position: relative;
      overflow: hidden;
    }
    
    /* Decorative gradient */
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #34c759, #007aff, #ff3b30);
      opacity: 0.5;
    }
    
    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }
    
    .header h2 {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.5px;
      color: #1d1d1f;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header h2 svg {
      width: 28px;
      height: 28px;
      color: #007aff;
    }
    
    /* Connection Status Badge */
    .connection-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 30px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #8e8e93;
    }
    
    .status-dot.connected {
      background: #34c759;
      box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.2);
      animation: pulse 2s infinite;
    }
    
    .status-dot.disabled {
      background: #8e8e93;
    }
    
    .status-dot.error {
      background: #ff3b30;
    }
    
    /* Form Groups */
    .form-group {
      margin-bottom: 24px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 8px;
      letter-spacing: -0.2px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      padding: 16px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 14px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin-bottom: 28px;
      transition: all 0.2s ease;
    }
    
    .checkbox-group:hover {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 122, 255, 0.2);
    }
    
    .checkbox-group label {
      flex: 1;
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-group label svg {
      width: 20px;
      height: 20px;
      color: #007aff;
    }
    
    /* Custom Checkbox */
    .checkbox-wrapper {
      position: relative;
      width: 52px;
      height: 32px;
      flex-shrink: 0;
    }
    
    .checkbox-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }
    
    .checkbox-slider {
      position: relative;
      display: block;
      width: 52px;
      height: 32px;
      background: #c7c7cc;
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
      cursor: pointer;
    }
    
    .checkbox-slider::before {
      content: '';
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 13px;
      background: white;
      top: 3px;
      left: 3px;
      transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .checkbox-input:checked + .checkbox-slider {
      background: #34c759;
    }
    
    .checkbox-input:checked + .checkbox-slider::before {
      transform: translateX(20px);
    }
    
    .checkbox-input:focus + .checkbox-slider {
      box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.2);
    }
    
    /* Input Fields */
    .input-wrapper {
      position: relative;
    }
    
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 16px 18px;
      font-size: 16px;
      border-radius: 14px;
      border: 1px solid #d2d2d7;
      background: rgba(255, 255, 255, 0.9);
      color: #1d1d1f;
      transition: all 0.25s ease;
      outline: none;
    }
    
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus {
      border-color: #007aff;
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
      background: #fff;
    }
    
    input::placeholder {
      color: #c7c7cc;
      font-size: 15px;
    }
    
    input:disabled {
      background: rgba(0, 0, 0, 0.04);
      color: #8e8e93;
      border-color: rgba(0, 0, 0, 0.08);
      cursor: not-allowed;
    }
    
    /* Password Field */
    .pw {
      position: relative;
    }
    
    .pw input {
      padding-right: 56px;
    }
    
    .icon-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #8e8e93;
      transition: all 0.2s ease;
    }
    
    .icon-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #1d1d1f;
    }
    
    .icon-btn:active {
      background: rgba(0, 0, 0, 0.08);
      transform: translateY(-50%) scale(0.96);
    }
    
    /* Hint Text */
    .hint {
      font-size: 13px;
      color: #8e8e93;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      line-height: 1.4;
    }
    
    .hint svg {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      margin-bottom: 28px;
    }
    
    .primary {
      flex: 2;
      padding: 18px 24px;
      font-size: 17px;
      font-weight: 600;
      background: linear-gradient(135deg, #007aff, #0056d6);
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
      letter-spacing: -0.2px;
      box-shadow: 0 4px 14px rgba(0, 122, 255, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .primary::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .primary:hover::after {
      left: 100%;
    }
    
    .primary:hover {
      background: linear-gradient(135deg, #0056d6, #0041a8);
      transform: translateY(-2px);
      box-shadow: 0 8px 22px rgba(0, 122, 255, 0.4);
    }
    
    .primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }
    
    .primary:disabled {
      background: #c7c7cc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .secondary {
      flex: 1;
      padding: 18px 16px;
      font-size: 16px;
      font-weight: 500;
      background: rgba(0, 0, 0, 0.03);
      color: #1d1d1f;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .secondary:hover:not(:disabled) {
      background: rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }
    
    .secondary:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .secondary.testing {
      background: rgba(52, 199, 89, 0.1);
      border-color: rgba(52, 199, 89, 0.3);
      color: #34c759;
    }
    
    .secondary.success {
      background: rgba(52, 199, 89, 0.1);
      border-color: rgba(52, 199, 89, 0.3);
      color: #34c759;
    }
    
    .secondary.error {
      background: rgba(255, 59, 48, 0.1);
      border-color: rgba(255, 59, 48, 0.3);
      color: #ff3b30;
    }
    
    /* Back Link */
    .link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 500;
      color: #007aff;
      text-decoration: none;
      border-radius: 12px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      gap: 8px;
      margin-top: 16px;
    }
    
    .link:hover {
      background: rgba(0, 122, 255, 0.08);
      border-color: rgba(0, 122, 255, 0.2);
    }
    
    .link:active {
      background: rgba(0, 122, 255, 0.12);
    }
    
    .link svg {
      width: 18px;
      height: 18px;
      transition: transform 0.2s ease;
    }
    
    .link:hover svg {
      transform: translateX(-3px);
    }
    
    /* Status Messages */
    .status {
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
      display: none;
      animation: slideIn 0.3s ease;
      font-weight: 500;
    }
    
    .status.success {
      background: rgba(52, 199, 89, 0.1);
      color: #34c759;
      border: 1px solid rgba(52, 199, 89, 0.2);
      display: block;
    }
    
    .status.error {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
      border: 1px solid rgba(255, 59, 48, 0.2);
      display: block;
    }
    
    .status.info {
      background: rgba(0, 122, 255, 0.1);
      color: #007aff;
      border: 1px solid rgba(0, 122, 255, 0.2);
      display: block;
    }
    
    .status.warning {
      background: rgba(255, 204, 0, 0.1);
      color: #b8860b;
      border: 1px solid rgba(255, 204, 0, 0.2);
      display: block;
    }
    
    /* Loading Animation */
    .loader {
      display: none;
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }
    
    .primary.loading .btn-text {
      display: none;
    }
    
    .primary.loading .loader {
      display: block;
    }
    
    /* Form Section Styling */
    .form-section {
      margin-bottom: 36px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }
    
    .form-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #007aff;
      border-radius: 2px;
      margin-right: 12px;
    }
    
    /* Visual indicator for disabled fields */
    .disabled-section {
      opacity: 0.7;
      position: relative;
    }
    
    .disabled-section::after {
      content: 'ðŸ”’ Disabled';
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.05);
      padding: 4px 8px;
      border-radius: 20px;
      color: #8e8e93;
    }
    
    /* Test Result */
    .test-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideIn 0.3s ease;
    }
    
    .test-result.success {
      background: rgba(52, 199, 89, 0.08);
      color: #2da44e;
    }
    
    .test-result.error {
      background: rgba(255, 59, 48, 0.08);
      color: #ff3b30;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    
    .error-shake {
      animation: shake 0.3s ease;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
      z-index: 100;
      white-space: nowrap;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .toast.success {
      background: rgba(52, 199, 89, 0.9);
    }
    
    .toast.error {
      background: rgba(255, 59, 48, 0.9);
    }
    
    .toast.info {
      background: rgba(0, 122, 255, 0.9);
    }
    
    /* Responsive */
    @media (max-width: 560px) {
      .card {
        padding: 24px 20px;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .header h2 {
        font-size: 24px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      input, .primary, .secondary, .link {
        padding: 15px 16px;
      }
      
      .checkbox-group {
        padding: 14px;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h2>
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6-2.5.03-1.99 4-3 6-3s5.97 1.01 6 3c-1.57 1.68-3.97 2.5-6 2.5z"/>
        </svg>
        MQTT Settings
      </h2>
      <div id="connectionBadge" class="connection-badge">
        <span id="statusDot" class="status-dot"></span>
        <span id="statusText">Loading...</span>
      </div>
    </div>
    
    <div id="status" class="status"></div>
    
    <form id="mqttForm">
      <div class="form-section">
        <div class="section-title">Connection</div>
        
        <div class="checkbox-group">
          <label for="enabled">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            Enable MQTT
          </label>
          <div class="checkbox-wrapper">
            <input type="checkbox" name="enabled" id="enabled" class="checkbox-input">
            <span class="checkbox-slider"></span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="host">Broker Address</label>
          <input type="text" name="host" id="host" placeholder="e.g., mqtt.example.com or 192.168.1.100">
          <div class="hint">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            IP address or hostname of your MQTT broker
          </div>
        </div>
        
        <div class="form-group">
          <label for="port">Port</label>
          <input type="number" name="port" id="port" value="1883" min="1" max="65535">
          <div class="hint">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            Default is 1883 (unencrypted) or 8883 (SSL/TLS)
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">Authentication</div>
        
        <div class="form-group">
          <label for="user">Username</label>
          <input type="text" name="user" id="user" placeholder="Leave empty for no authentication">
          <div class="hint">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            Optional: username for broker authentication
          </div>
        </div>
        
        <div class="form-group">
          <label for="mpass">Password</label>
          <div class="pw">
            <input type="password" name="pass" id="mpass" placeholder="Enter password if required">
            <button type="button" class="icon-btn" onclick="toggleMPass()" aria-label="Show password">
              <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/>
              </svg>
            </button>
          </div>
          <div class="hint">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path fill="currentColor" d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
            </svg>
            Password is stored securely and never shown
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">Topics</div>
        
        <div class="form-group">
          <label for="cmdTopic">Command Topic <span style="color: #ff3b30; font-size: 12px;">*</span></label>
          <input type="text" name="cmdTopic" id="cmdTopic" placeholder="e.g., switchNode/relay/command">
          <div class="hint">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path fill="currentColor" d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm0-6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm0-6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
            </svg>
            Required: Topic to listen for ON/OFF commands
          </div>
        </div>
        
        <div class="form-group">
          <label for="stateTopic">State Topic</label>
          <input type="text" name="stateTopic" id="stateTopic" placeholder="e.g., switchNode/relay/state">
          <div class="hint">
            <svg viewBox="0 0 24 24" width="14" height="14">
              <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 6h-2v6h2v2h-4V9h-2V7h6v2z"/>
            </svg>
            Optional: Topic for publishing state changes
          </div>
        </div>
        
        <div class="hint" style="margin-top: 16px; padding: 12px; background: rgba(0, 122, 255, 0.05); border-radius: 10px;">
          <svg viewBox="0 0 24 24" width="16" height="16" style="color: #007aff;">
            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
          </svg>
          <span>Digital Input state is published to: <code id="dinTopicPreview">[cmdTopic]/din</code></span>
        </div>
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="primary" id="submitBtn">
          <span class="btn-text">Save Settings</span>
          <div class="loader"></div>
        </button>
        <button type="button" class="secondary" id="testBtn" title="Test MQTT connection">
          <svg viewBox="0 0 24 24" width="18" height="18">
            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
          </svg>
          <span>Test</span>
        </button>
      </div>
    </form>
    
    <div id="testResult" class="test-result" style="display: none;"></div>
    
    <a href="/" class="link">
      <svg viewBox="0 0 24 24" width="18" height="18">
        <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      Back to Dashboard
    </a>
  </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>

<script>
  (function() {
    'use strict';
    
    // DOM Elements
    const elements = {
      form: document.getElementById('mqttForm'),
      submitBtn: document.getElementById('submitBtn'),
      testBtn: document.getElementById('testBtn'),
      statusEl: document.getElementById('status'),
      toast: document.getElementById('toast'),
      testResult: document.getElementById('testResult'),
      connectionBadge: document.getElementById('connectionBadge'),
      statusDot: document.getElementById('statusDot'),
      statusText: document.getElementById('statusText'),
      enabledCheckbox: document.getElementById('enabled'),
      hostInput: document.getElementById('host'),
      portInput: document.getElementById('port'),
      userInput: document.getElementById('user'),
      passInput: document.getElementById('mpass'),
      cmdTopicInput: document.getElementById('cmdTopic'),
      stateTopicInput: document.getElementById('stateTopic'),
      dinTopicPreview: document.getElementById('dinTopicPreview')
    };

    // State
    let state = {
      toastTimeout: null,
      refreshInterval: null,
      currentMqttStatus: null
    };

    // ========== UTILITY FUNCTIONS ==========
    
    function showToast(message, type = 'info', duration = 3000) {
      if (state.toastTimeout) clearTimeout(state.toastTimeout);
      
      elements.toast.textContent = message;
      elements.toast.className = `toast ${type} show`;
      
      state.toastTimeout = setTimeout(() => {
        elements.toast.classList.remove('show');
      }, duration);
    }

    function showStatus(message, type = 'success', duration = 5000) {
      elements.statusEl.textContent = message;
      elements.statusEl.className = `status ${type}`;
      
      if (duration > 0) {
        setTimeout(() => {
          elements.statusEl.className = 'status';
        }, duration);
      }
    }

    function showTestResult(message, type = 'success') {
      elements.testResult.textContent = message;
      elements.testResult.className = `test-result ${type}`;
      elements.testResult.style.display = 'flex';
      
      setTimeout(() => {
        elements.testResult.style.display = 'none';
      }, 5000);
    }

    function toggleMPass() {
      const type = elements.passInput.getAttribute('type') === 'password' ? 'text' : 'password';
      elements.passInput.setAttribute('type', type);
      const iconBtn = elements.passInput.nextElementSibling;
      iconBtn.setAttribute('aria-label', type === 'password' ? 'Show password' : 'Hide password');
    }

    // ========== VALIDATION ==========
    
    function validateForm() {
      if (!elements.enabledCheckbox.checked) return true;
      
      if (!elements.hostInput.value.trim()) {
        showStatus('Broker address is required when MQTT is enabled', 'error');
        elements.hostInput.focus();
        elements.hostInput.classList.add('error-shake');
        setTimeout(() => elements.hostInput.classList.remove('error-shake'), 300);
        return false;
      }
      
      if (!elements.cmdTopicInput.value.trim()) {
        showStatus('Command topic is required when MQTT is enabled', 'error');
        elements.cmdTopicInput.focus();
        elements.cmdTopicInput.classList.add('error-shake');
        setTimeout(() => elements.cmdTopicInput.classList.remove('error-shake'), 300);
        return false;
      }
      
      const port = parseInt(elements.portInput.value);
      if (isNaN(port) || port < 1 || port > 65535) {
        showStatus('Port must be between 1 and 65535', 'error');
        elements.portInput.focus();
        elements.portInput.classList.add('error-shake');
        setTimeout(() => elements.portInput.classList.remove('error-shake'), 300);
        return false;
      }
      
      // Validate hostname format
      const host = elements.hostInput.value.trim();
      const hostRegex = /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$|^(\d{1,3}\.){3}\d{1,3}$|^localhost$/;
      if (!hostRegex.test(host) && !host.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) {
        showStatus('Please enter a valid hostname or IP address', 'warning');
        // Non-blocking warning
      }
      
      return true;
    }

    // ========== UI UPDATES ==========
    
    function updateDinTopicPreview() {
      const cmdTopic = elements.cmdTopicInput.value.trim();
      if (cmdTopic) {
        elements.dinTopicPreview.textContent = `${cmdTopic}/din`;
      } else {
        elements.dinTopicPreview.textContent = '[cmdTopic]/din';
      }
    }

    function updateFieldStates() {
      const enabled = elements.enabledCheckbox.checked;
      const allInputs = [
        elements.hostInput, elements.portInput, 
        elements.userInput, elements.passInput, 
        elements.cmdTopicInput, elements.stateTopicInput
      ];
      
      allInputs.forEach(input => {
        input.disabled = !enabled;
        input.style.opacity = !enabled ? '0.7' : '1';
        input.style.cursor = !enabled ? 'not-allowed' : 'text';
        input.style.backgroundColor = !enabled ? 'rgba(0, 0, 0, 0.03)' : '';
      });
      
      // Update form sections
      const sections = document.querySelectorAll('.form-section:not(:first-child)');
      sections.forEach(section => {
        if (!enabled) {
          section.classList.add('disabled-section');
        } else {
          section.classList.remove('disabled-section');
        }
      });
      
      // Update test button
      elements.testBtn.disabled = !enabled;
      elements.testBtn.style.opacity = !enabled ? '0.5' : '1';
    }

    function updateConnectionStatus(data) {
      state.currentMqttStatus = data;
      
      if (!data.mqtt_enabled) {
        elements.statusDot.className = 'status-dot disabled';
        elements.statusText.textContent = 'MQTT Disabled';
        return;
      }
      
      if (data.mqtt_connected) {
        elements.statusDot.className = 'status-dot connected';
        elements.statusText.textContent = 'Connected';
      } else {
        elements.statusDot.className = 'status-dot error';
        elements.statusText.textContent = 'Disconnected';
      }
    }

    // ========== API CALLS ==========
    
    async function loadSettings() {
      try {
        const response = await fetch('/api/mqtt');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('ðŸ“¥ Loaded MQTT settings:', {
          ...data,
          pass: data.pass_set ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '(not set)'
        });
        
        // Populate form
        elements.enabledCheckbox.checked = data.enabled || false;
        elements.hostInput.value = data.host || '';
        elements.portInput.value = data.port || 1883;
        elements.userInput.value = data.user || '';
        
        if (data.pass_set) {
          elements.passInput.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (password saved)';
          elements.passInput.value = '';
        } else {
          elements.passInput.placeholder = 'Enter password if required';
        }
        
        elements.cmdTopicInput.value = data.cmdTopic || '';
        elements.stateTopicInput.value = data.stateTopic || '';
        
        // Update UI
        updateFieldStates();
        updateDinTopicPreview();
        
        // Fetch current connection status
        fetchStatus();
        
        showToast('Settings loaded', 'success', 2000);
        
      } catch (error) {
        console.error('Failed to load settings:', error);
        showStatus('Failed to load settings. Using defaults.', 'error', 5000);
      }
    }

    async function fetchStatus() {
      try {
        const response = await fetch('/api/status');
        if (response.ok) {
          const data = await response.json();
          updateConnectionStatus(data);
        }
      } catch (error) {
        console.error('Failed to fetch status:', error);
      }
    }

    async function testConnection() {
      if (!validateForm()) return false;
      
      elements.testBtn.classList.add('testing');
      elements.testBtn.disabled = true;
      elements.testBtn.innerHTML = `
        <div class="loader" style="display: block; border-top-color: #34c759;"></div>
        <span>Testing...</span>
      `;
      
      try {
        // First, save the current settings temporarily
        const formData = new URLSearchParams();
        formData.append('enabled', '1');
        formData.append('host', elements.hostInput.value.trim());
        formData.append('port', elements.portInput.value);
        formData.append('user', elements.userInput.value.trim());
        formData.append('pass', elements.passInput.value);
        formData.append('cmdTopic', elements.cmdTopicInput.value.trim());
        formData.append('stateTopic', elements.stateTopicInput.value.trim());
        
        // Save settings temporarily
        const saveResponse = await fetch('/api/mqtt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData.toString()
        });
        
        if (!saveResponse.ok) {
          throw new Error('Failed to save test settings');
        }
        
        // Wait for MQTT to attempt connection
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Check status
        const statusResponse = await fetch('/api/status');
        const statusData = await statusResponse.json();
        
        if (statusData.mqtt_connected) {
          showTestResult('âœ… Connection successful!', 'success');
          showToast('MQTT connection test passed', 'success');
          elements.testBtn.className = 'secondary success';
        } else {
          showTestResult('âŒ Connection failed. Check broker settings.', 'error');
          showToast('Connection test failed', 'error');
          elements.testBtn.className = 'secondary error';
        }
        
        updateConnectionStatus(statusData);
        
      } catch (error) {
        console.error('Test failed:', error);
        showTestResult('âŒ Test error: ' + error.message, 'error');
        showToast('Test failed', 'error');
        elements.testBtn.className = 'secondary error';
      } finally {
        setTimeout(() => {
          elements.testBtn.classList.remove('testing', 'success', 'error');
          elements.testBtn.innerHTML = `
            <svg viewBox="0 0 24 24" width="18" height="18">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
            </svg>
            <span>Test</span>
          `;
          elements.testBtn.disabled = false;
        }, 3000);
      }
      
      return true;
    }

    // ========== EVENT HANDLERS ==========
    
    async function handleSubmit(e) {
      e.preventDefault();
      
      if (!validateForm()) return;
      
      // Confirmation for disabling MQTT
      if (!elements.enabledCheckbox.checked && state.currentMqttStatus?.mqtt_enabled) {
        if (!confirm('âš ï¸ Disabling MQTT will disconnect from broker and stop all MQTT communication. Continue?')) {
          return;
        }
      }
      
      // Show loading
      elements.submitBtn.classList.add('loading');
      elements.submitBtn.disabled = true;
      
      // Prepare data
      const formData = new URLSearchParams();
      formData.append('enabled', elements.enabledCheckbox.checked ? '1' : '0');
      formData.append('host', elements.hostInput.value.trim());
      formData.append('port', elements.portInput.value);
      formData.append('user', elements.userInput.value.trim());
      formData.append('pass', elements.passInput.value);
      formData.append('cmdTopic', elements.cmdTopicInput.value.trim());
      formData.append('stateTopic', elements.stateTopicInput.value.trim());
      
      console.log('ðŸ“¤ Submitting MQTT settings:', {
        enabled: elements.enabledCheckbox.checked,
        host: elements.hostInput.value.trim(),
        port: elements.portInput.value,
        user: elements.userInput.value.trim(),
        pass: elements.passInput.value ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '(empty)',
        cmdTopic: elements.cmdTopicInput.value.trim(),
        stateTopic: elements.stateTopicInput.value.trim()
      });
      
      try {
        const response = await fetch('/api/mqtt', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData.toString()
        });
        
        let result;
        const responseText = await response.text();
        
        try {
          result = JSON.parse(responseText);
        } catch (e) {
          console.error('Invalid JSON response:', responseText);
          throw new Error('Invalid server response');
        }
        
        if (!response.ok) {
          throw new Error(result.err || `HTTP ${response.status}`);
        }
        
        console.log('âœ… Save successful:', result);
        
        showStatus('âœ“ MQTT settings saved successfully!', 'success');
        showToast('Settings saved', 'success');
        
        // Reload settings to confirm
        setTimeout(() => {
          loadSettings();
          fetchStatus();
        }, 1500);
        
      } catch (error) {
        console.error('âŒ Save failed:', error);
        showStatus(`âœ— Failed to save: ${error.message}`, 'error', 7000);
        showToast('Save failed', 'error');
      } finally {
        elements.submitBtn.classList.remove('loading');
        elements.submitBtn.disabled = false;
      }
    }

    // ========== INITIALIZATION ==========
    
    function init() {
      // Load settings
      loadSettings();
      
      // Set up event listeners
      elements.form.addEventListener('submit', handleSubmit);
      elements.testBtn.addEventListener('click', testConnection);
      elements.enabledCheckbox.addEventListener('change', updateFieldStates);
      elements.cmdTopicInput.addEventListener('input', updateDinTopicPreview);
      
      // Auto-refresh connection status every 5 seconds
      state.refreshInterval = setInterval(fetchStatus, 5000);
      
      // Focus on first field
      setTimeout(() => {
        if (elements.enabledCheckbox.checked) {
          elements.hostInput.focus();
        } else {
          elements.enabledCheckbox.focus();
        }
      }, 500);
      
      // Handle visibility change
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          if (state.refreshInterval) {
            clearInterval(state.refreshInterval);
            state.refreshInterval = null;
          }
        } else {
          if (!state.refreshInterval) {
            fetchStatus();
            state.refreshInterval = setInterval(fetchStatus, 5000);
          }
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          elements.form.dispatchEvent(new Event('submit'));
        }
        if (e.key === 't' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          elements.testBtn.click();
        }
      });
      
      console.log('ðŸš€ MQTT Settings page initialized');
    }

    // Expose toggle function globally
    window.toggleMPass = toggleMPass;
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
</body>
</html>